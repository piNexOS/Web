@page
@model Web.Pages.Home.IndexModel
@{
    var hoje = DateOnly.FromDateTime(DateTime.Today);
}

<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>NexOS - Dashboard</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --cor-fundo: #373F46;
            --cor-card: #2E343A;
            --cor-header: #272C2F;
            --cor-texto: #fff;
            --realizadas: #43B0F1;
            --rejeitadas: #1B4965;
            --pendentes: #6A4C93;
        }

        body {
            margin: 0;
            background: var(--cor-fundo);
            color: var(--cor-texto);
            font-family: "Poppins", sans-serif;
        }

        main {
            padding: 3em;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2.5em;
        }

        .linha-graficos {
            display: flex;
            width: 100%;
            max-width: 1300px;
            justify-content: center;
            gap: 2em;
        }

        .card-grafico {
            flex: 1;
            background: var(--cor-card);
            padding: 2em;
            border-radius: 12px;
            min-height: 380px;
        }

        h2 {
            margin-bottom: 1em;
        }

        .legenda-os {
            margin-top: 1.5em;
            display: flex;
            justify-content: space-around;
        }

        .legenda-item {
            display: flex;
            align-items: center;
            gap: 0.6em;
            font-size: 1.1em;
        }

        .cor-box {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        /* ESTILOS DAS TABELAS (restaurados) */
        .tabela-card {
            width: 100%;
            max-width: 1300px;
            background: var(--cor-card);
            padding: 1.5em;
            border-radius: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            border-radius: 10px;
            overflow: hidden;
        }

        thead {
            background: var(--cor-header);
        }

        th, td {
            padding: 0.9rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        tr:hover td {
            background: rgba(255,255,255,0.08);
        }
    </style>
</head>

<body>

    <main>

        <div class="linha-graficos">

            <!-- GRÁFICO DE OS'S -->
            <div class="card-grafico">
                <h2>Gráfico de OS's</h2>
                <canvas id="graficoOS"></canvas>

                <div class="legenda-os">
                    <div class="legenda-item">
                        <div class="cor-box" style="background: var(--realizadas)"></div>
                        Realizadas — @Model.PctRealizadas% (@Model.TotalRealizadas)
                    </div>

                    <div class="legenda-item">
                        <div class="cor-box" style="background: var(--rejeitadas)"></div>
                        Rejeitadas — @Model.PctRejeitadas% (@Model.TotalRejeitadas)
                    </div>

                    <div class="legenda-item">
                        <div class="cor-box" style="background: var(--pendentes)"></div>
                        Pendentes — @Model.PctPendentes% (@Model.TotalPendentes)
                    </div>
                </div>
            </div>

            <!-- GRÁFICO DE REGIÕES -->
            <div class="card-grafico">
                <h2>Gráfico de Regiões</h2>
                <canvas id="graficoRegiao"></canvas>
            </div>

        </div>

        <!-- ========== TABELAS RESTAURADAS ========== -->

        <div class="tabela-card">
            <h2>Agentes em atividade</h2>

            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>ID</th>
                        <th>Programadas</th>
                        <th>Atendidas</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var item in Model.TabAgentes)
                    {
                        <tr>
                            <td>@item.Nome</td>
                            <td>@item.Matricula</td>
                            <td>
                                @(item.Roteiros?
                                                            .Where(r => r.Data == hoje)
                                                            .Sum(r => r.RoteiroDetalhes?.Count() ?? 0) ?? 0)
                                                                                                        </td>

                            <td>
                                @(item.Roteiros?
                                                            .SelectMany(r => r.RoteiroDetalhes)
                                                            .Count(d => d.IdOrdemServicoNavigation != null &&
                                                            d.IdOrdemServicoNavigation.DataBaixa.HasValue &&
                                                            d.IdOrdemServicoNavigation.DataBaixa.Value.Date == DateTime.Today)
                                                            ?? 0)
                        </td>
                    </tr>
                                        }
                </tbody>
            </table>
        </div>

        <div class="tabela-card">
            <h2>Ordens Rejeitadas</h2>

            <table>
                <thead>
                    <tr>
                        <th>Serviço</th>
                        <th>ID OS</th>
                        <th>Bairro</th>
                        <th>Endereço</th>
                        <th>Motivo</th>
                        <th>Agente</th>
                    </tr>
                </thead>

                <tbody>
                    @foreach (var item in Model.OrdensServicosRejs)
                    {
                        <tr>
                            <td>@item.IdRoteiroDetalhesNavigation.IdOrdemServicoNavigation.IdTabServicoNavigation.Descricao</td>
                            <td>@item.IdRoteiroDetalhesNavigation.IdOrdemServico</td>
                            <td>@item.IdRoteiroDetalhesNavigation.IdOrdemServicoNavigation.IdTabBairroNavigation.Descricao</td>
                            <td>@item.IdRoteiroDetalhesNavigation.IdOrdemServicoNavigation.Endereco</td>
                            <td>@item.Motivo</td>
                            <td>@item.IdRoteiroDetalhesNavigation.IdRoteiroNavigation.IdTabAgenteNavigation.Nome</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- FIM DAS TABELAS -->

    </main>

    <script>

        const r = @Model.TotalRealizadas == 0 ? 0.0001 : @Model.TotalRealizadas;
        const j = @Model.TotalRejeitadas == 0 ? 0.0001 : @Model.TotalRejeitadas;
        const p = @Model.TotalPendentes == 0 ? 0.0001 : @Model.TotalPendentes;

        new Chart(document.getElementById("graficoOS"), {
            type: "doughnut",
            data: {
                labels: ["Realizadas", "Rejeitadas", "Pendentes"],
                datasets: [{
                    data: [r, j, p],
                    backgroundColor: [
                        getComputedStyle(document.documentElement).getPropertyValue("--realizadas").trim(),
                        getComputedStyle(document.documentElement).getPropertyValue("--rejeitadas").trim(),
                        getComputedStyle(document.documentElement).getPropertyValue("--pendentes").trim()
                    ],
                    borderWidth: 0,
                    spacing: 5
                }]
            },
            options: {
                cutout: "65%",
                plugins: { legend: { display: false } }
            }
        });

        const regioes = @Html.Raw(Model.RegioesJSON);
        const quantidades = @Html.Raw(Model.QuantidadesRegioesJSON);

        new Chart(document.getElementById("graficoRegiao"), {
            type: "bar",
            data: {
                labels: regioes,
                datasets: [{
                    label: "Quantidade",
                    data: quantidades,
                    backgroundColor: "#26a5ee"
                }]
            },
            options: {
                plugins: { legend: { labels: { color: "white" } } },
                scales: {
                    x: { ticks: { color: "white" } },
                    y: { ticks: { color: "white" } }
                }
            }
        });
    </script>

</body>
</html>
